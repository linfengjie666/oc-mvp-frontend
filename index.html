<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Economics - Opportunity Cost ç»ƒä¹ </title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 16px;
        }
        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            font-size: 20px;
            color: #333;
            margin-bottom: 8px;
        }
        h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 12px;
        }
        .subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
        }
        .btn {
            width: 100%;
            padding: 14px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #34C759;
        }
        .btn-outline {
            background: white;
            border: 2px solid #007AFF;
            color: #007AFF;
        }
        .btn-danger {
            background: #FF3B30;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Dashboard */
        .dashboard-card {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .progress-bar {
            height: 8px;
            background: #e5e5e5;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007AFF;
            transition: width 0.3s;
        }
        .progress-text {
            font-size: 14px;
            color: #666;
        }
        .weakness-box {
            background: #FFF3CD;
            border: 1px solid #FFCA28;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
        }
        .weakness-title {
            color: #856404;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .weakness-desc {
            font-size: 14px;
            color: #856404;
        }
        .stable-box {
            background: #D4EDDA;
            border: 1px solid #28A745;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
        }
        .stable-title {
            color: #155724;
            font-weight: 600;
        }
        
        /* Question */
        .question-card {
            margin-bottom: 16px;
        }
        .question-num {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .question-stem {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 16px;
            white-space: pre-wrap;
        }
        .option {
            padding: 14px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option:hover {
            border-color: #007AFF;
            background: #f0f7ff;
        }
        .option.selected {
            border-color: #007AFF;
            background: #e8f4ff;
        }
        .option-label {
            font-weight: 600;
            margin-right: 8px;
        }
        
        /* Result */
        .result-card {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            text-align: center;
        }
        .result-percent {
            font-size: 48px;
            font-weight: 700;
            color: #007AFF;
        }
        .result-label {
            font-size: 14px;
            color: #666;
        }
        .dim-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .dim-name {
            width: 120px;
            font-size: 14px;
        }
        .dim-bar {
            flex: 1;
            height: 8px;
            background: #e5e5e5;
            border-radius: 4px;
            margin: 0 12px;
            overflow: hidden;
        }
        .dim-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .dim-fill.ok { background: #34C759; }
        .dim-fill.weak { background: #FF3B30; }
        .dim-fill.attention { background: #FF9500; }
        .dim-fill.insufficient { background: #8E8E93; }
        .dim-percent {
            width: 50px;
            text-align: right;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Message */
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .message-info { background: #E3F2FD; color: #1565C0; }
        .message-success { background: #E8F5E9; color: #2E7D32; }
        .message-warning { background: #FFF3E0; color: #E65100; }
        .message-error { background: #FFEBEE; color: #C62828; }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* Hidden */
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•é¡µ -->
        <div id="page-login">
            <h1>DSE Economics</h1>
            <p class="subtitle">æ©Ÿæœƒæˆæœ¬ (Opportunity Cost) ç·´ç¿’</p>
            <p>æ­£åœ¨åŠ è¼‰...</p>
        </div>
        
        <!-- Dashboard -->
        <div id="page-dashboard" class="hidden">
            <h1>1.2 æ©Ÿæœƒæˆæœ¬</h1>
            <p class="subtitle" id="dashboard-user"></p>
            
            <div class="dashboard-card">
                <p class="progress-text">Micro Session é€²åº¦</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="buffer-progress" style="width: 0%"></div>
                </div>
                <p class="progress-text" id="buffer-text">0 / 3</p>
            </div>
            
            <div id="weakness-display"></div>
            
            <button class="btn btn-secondary" onclick="goToMicro()">é–‹å§‹ç·´ç¿’</button>
            <button class="btn btn-outline" onclick="refreshDashboard()">é‡æ–°æ•´ç†</button>
        </div>
        
        <!-- Micro Session -->
        <div id="page-micro" class="hidden">
            <h2>Micro Session</h2>
            <div id="micro-content">
                <div class="loading">è¼‰å…¥é¡Œç›®ä¸­...</div>
            </div>
        </div>
        
        <!-- Evaluation -->
        <div id="page-evaluation" class="hidden">
            <h2>è©•å®šçµæœ</h2>
            <div id="eval-content">
                <div class="loading">è¨ˆç®—ä¸­...</div>
            </div>
        </div>
        
        <!-- Challenge -->
        <div id="page-challenge" class="hidden">
            <h2>å°ˆé …æŒ‘æˆ°</h2>
            <p class="subtitle" id="challenge-dim"></p>
            <div id="challenge-content">
                <div class="loading">è¼‰å…¥é¡Œç›®ä¸­...</div>
            </div>
        </div>
        
        <!-- Challenge Result -->
        <div id="page-challenge-result" class="hidden">
            <h2>æŒ‘æˆ°å®Œæˆ</h2>
            <div id="challenge-result-content"></div>
        </div>
    </div>
    
    <script>
        // ============================================================
        // é…ç½®
        // ============================================================
        // ç”Ÿäº§ç¯å¢ƒé»˜è®¤ APIï¼ˆéƒ¨ç½²åæ›¿æ¢ä¸ºçœŸå® URLï¼‰
        const DEFAULT_API = 'https://dse-economics-oc.onrender.com';
        
        // URL å‚æ•°ä¼˜å…ˆçº§ï¼š?api= > DEFAULT_API > localhostï¼ˆè°ƒè¯•ç”¨ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const API_PARAM = urlParams.get('api');
        const BASE_URL_RAW = API_PARAM || DEFAULT_API;
        const BASE_URL = BASE_URL_RAW.replace(/^http:\/\//i, 'https://');
        
        // localStorage key
        const STORAGE_KEY_USER_ID = 'oc_mvp_user_id';
        
        // console.log ä¾¿äº debug
        console.log('API Endpoint:', BASE_URL);
        
        // ============================================================
        // å…¨å±€çŠ¶æ€
        // ============================================================
        let currentUser = '';
        let currentQuestions = [];
        let currentAnswers = {};
        let currentQuestionIndex = 0;
        let currentWeakDimension = '';
        let apiReady = false;
        
        // ============================================================
        // å·¥å…·å‡½æ•°
        // ============================================================
        function showPage(pageId) {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }
        
        function showMessage(msg, type = 'info') {
            return `<div class="message message-${type}">${msg}</div>`;
        }
        
        function dimToCn(dim) {
            const map = {
                'COST_STRUCTURE': 'æˆæœ¬çµæ§‹',
                'ALT_LOGIC': 'æ¯”è¼ƒé‚è¼¯',
                'SUNK_FILTER': 'æ²‰æ²’æˆæœ¬'
            };
            return map[dim] || dim;
        }
        
        // æ£€æŸ¥ API æ˜¯å¦å¯ç”¨
        async function checkApiHealth() {
            try {
                const response = await fetch(`${BASE_URL}/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    apiReady = true;
                    return true;
                }
            } catch (e) {
                console.error('Health check failed:', e);
            }
            return false;
        }
        
        async function apiCall(endpoint, options = {}) {
            if (!apiReady) {
                throw new Error('API æœªå°±ç·’ï¼Œè«‹åˆ·æ–°é é¢');
            }
            const url = `${BASE_URL}${endpoint}`;
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (!response.ok) {
                const err = await response.json().catch(() => ({detail: 'Unknown error'}));
                throw new Error(err.detail || 'API error');
            }
            return response.json();
        }
        
        // ============================================================
        // é¡µé¢: Login
        // ============================================================
        
        // è·å–ä¸Šæ¬¡ä¿å­˜çš„ user_id
        function getSavedUserId() {
            return localStorage.getItem(STORAGE_KEY_USER_ID) || '';
        }
        
        // ä¿å­˜ user_id
        function saveUserId(userId) {
            localStorage.setItem(STORAGE_KEY_USER_ID, userId);
        }
        
        // åˆå§‹åŒ–ï¼šå…ˆæ£€æŸ¥ APIï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•é€»è¾‘ï¼‰
        async function initApp() {
            const loginPage = document.getElementById('page-login');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆå†·å¯åŠ¨æç¤ºï¼‰
            loginPage.innerHTML = `
                <h1>DSE Economics - æ©Ÿæœƒæˆæœ¬ç·´ç¿’</h1>
                <p class="subtitle">æ­£åœ¨é€£æ¥æœå‹™å™¨...</p>
                <div style="text-align:center;padding:20px;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top:12px;font-size:12px;color:#666;">
                        é¦–æ¬¡æ‰“é–‹å¯èƒ½éœ€è¦ 10â€“30 ç§’å•Ÿå‹•ï¼ˆå…è²»æœå‹™å™¨ï¼‰
                    </p>
                </div>
                <p style="font-size:11px;color:#999;margin-top:16px;">API: ${BASE_URL}</p>
            `;
            
            // å¸¦è¶…æ—¶çš„å¥åº·æ£€æŸ¥ï¼ˆæœ€å¤šç­‰ 5 ç§’æ˜¾ç¤ºæç¤ºï¼‰
            let isHealthy = false;
            const healthCheckPromise = checkApiHealth();
            const timeoutPromise = new Promise(resolve => setTimeout(resolve, 5000));
            
            try {
                isHealthy = await Promise.race([healthCheckPromise, timeoutPromise]);
            } catch (e) {
                console.error('Health check error:', e);
            }
            
            // å¦‚æœè¿˜æ²¡æˆåŠŸï¼Œå†ç­‰ä¸€ä¸‹ï¼ˆæ€»å…±æœ€å¤š 10 ç§’ï¼‰
            if (!isHealthy) {
                loginPage.innerHTML = `
                    <h1>DSE Economics - æ©Ÿæœƒæˆæœ¬ç·´ç¿’</h1>
                    <p class="subtitle">æœå‹™å™¨æ­£åœ¨å•Ÿå‹•ä¸­...</p>
                    <div style="text-align:center;padding:20px;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top:12px;font-size:14px;color:#666;">
                            å…è²»æœå‹™å™¨é¦–æ¬¡å•Ÿå‹•éœ€è¦ 10â€“30 ç§’<br>è«‹ç¨å€™...
                        </p>
                    </div>
                    <button class="btn" onclick="initApp()">é‡æ–°æª¢æŸ¥</button>
                    <p style="font-size:11px;color:#999;margin-top:16px;">API: ${BASE_URL}</p>
                `;
                
                // å†ç­‰ 10 ç§’è®©ç”¨æˆ·çœ‹
                await new Promise(resolve => setTimeout(resolve, 10000));
                
                // å†æ¬¡æ£€æŸ¥
                isHealthy = await checkApiHealth();
            }
            
            if (!isHealthy) {
                loginPage.innerHTML = `
                    <h1>âš ï¸ é€£æ¥å¤±æ•—</h1>
                    <p class="subtitle">ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨</p>
                    <div class="message message-error">
                        <p><strong>ç„¡æ³•é€£æ¥æœå‹™å™¨ï¼Œè«‹ç¨å¾Œå†è©¦</strong></p>
                        <p style="margin-top:8px;font-size:12px;">å¦‚æœæŒçºŒå¤±æ•—ï¼Œè«‹è¯ç¹«è€å¸«</p>
                        <p style="font-size:11px;margin-top:12px;">ç•¶å‰ API: <code>${BASE_URL}</code></p>
                    </div>
                    <button class="btn btn-primary" onclick="initApp()">é‡è©¦é€£æ¥</button>
                `;
                return;
            }
            
            // API å°±ç»ªï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢ï¼ˆå¸¦ localStorage é€»è¾‘ï¼‰
            const savedUserId = getSavedUserId();
            
            if (savedUserId) {
                // æœ‰ä¿å­˜çš„ç”¨æˆ·ï¼Œæ˜¾ç¤º"ç»§ç»­"æŒ‰é’®
                loginPage.innerHTML = `
                    <h1>DSE Economics - æ©Ÿæœƒæˆæœ¬ç·´ç¿’</h1>
                    <p class="subtitle">å¼±é»è­˜åˆ¥ç³»çµ± - MVP</p>
                    <input type="text" id="input-user-id" placeholder="è¼¸å…¥ä½ çš„åå­—æˆ–ç·¨è™Ÿ" value="${savedUserId}" />
                    <button class="btn btn-primary" onclick="startApp()">é–‹å§‹ç·´ç¿’</button>
                    <button class="btn" style="margin-top:8px;background:#4CAF50;color:white;" onclick="continueAsLastUser()">ç¹¼çºŒä¸Šæ¬¡ (${savedUserId})</button>
                    <p style="font-size:11px;color:#999;margin-top:16px;">API: ${BASE_URL}</p>
                `;
            } else {
                // æ²¡æœ‰ä¿å­˜çš„ç”¨æˆ·
                loginPage.innerHTML = `
                    <h1>DSE Economics - æ©Ÿæœƒæˆæœ¬ç·´ç¿’</h1>
                    <p class="subtitle">å¼±é»è­˜åˆ¥ç³»çµ± - MVP</p>
                    <input type="text" id="input-user-id" placeholder="è¼¸å…¥ä½ çš„åå­—æˆ–ç·¨è™Ÿ" />
                    <button class="btn btn-primary" onclick="startApp()">é–‹å§‹ç·´ç¿’</button>
                    <p style="font-size:11px;color:#999;margin-top:16px;">API: ${BASE_URL}</p>
                `;
            }
        }
        
        // ç»§ç»­ä¸Šæ¬¡ç”¨æˆ·
        async function continueAsLastUser() {
            const savedUserId = getSavedUserId();
            if (savedUserId) {
                currentUser = savedUserId;
                await showDashboard();
            }
        }

        // æ˜¾ç¤º Dashboard é¡µé¢ï¼ˆwrapperï¼‰
        async function showDashboard() {
            showPage('page-dashboard');
            await refreshDashboard();
        }
        
        // é¡µé¢: Dashboard
        window.onload = initApp;
        
        function startApp() {
            const userId = document.getElementById('input-user-id').value.trim();
            if (!userId) {
                alert('è«‹è¼¸å…¥åå­—æˆ–ç·¨è™Ÿ');
                return;
            }
            currentUser = userId;
            saveUserId(userId);  // ä¿å­˜åˆ° localStorage
            refreshDashboard();
        }
        
        // ============================================================
        // é¡µé¢: Dashboard
        // ============================================================
        async function refreshDashboard() {
            try {
                const data = await apiCall(`/dashboard?user_id=${currentUser}`);
                
                document.getElementById('dashboard-user').textContent = `å­¸ç”Ÿ: ${currentUser}`;
                
                // Buffer è¿›åº¦
                const buffer = data.eval_buffer;
                const bufferPercent = (buffer.current / buffer.max) * 100;
                document.getElementById('buffer-progress').style.width = `${bufferPercent}%`;
                document.getElementById('buffer-text').textContent = `${buffer.current} / ${buffer.max}`;
                
                // å¼±ç‚¹æ˜¾ç¤º
                const weaknessDiv = document.getElementById('weakness-display');
                if (data.primary_weakness) {
                    const w = data.primary_weakness;
                    if (w.status === 'WEAK_DETECTED') {
                        weaknessDiv.innerHTML = `
                            <div class="weakness-box">
                                <div class="weakness-title">âš ï¸ ç•¶å‰å¼±é»</div>
                                <div class="weakness-desc">${w.dimension_cn} (é‚„éœ€ ${w.remaining} æ¬¡é”æ¨™)</div>
                            </div>
                        `;
                    } else if (w.status === 'STABLE') {
                        weaknessDiv.innerHTML = `
                            <div class="stable-box">
                                <div class="stable-title">âœ… ${w.dimension_cn} å·²ç©©å®š</div>
                            </div>
                        `;
                    }
                } else {
                    weaknessDiv.innerHTML = `
                        <div class="stable-box">
                            <div class="stable-title">âœ… å„ç¶­åº¦è¡¨ç¾è‰¯å¥½</div>
                        </div>
                    `;
                }
                
                showPage('page-dashboard');
            } catch (e) {
                alert('è¼‰å…¥å¤±æ•—: ' + e.message);
            }
        }
        
        // ============================================================
        // é¡µé¢: Micro Session
        // ============================================================
        async function goToMicro() {
            currentQuestionIndex = 0;
            currentAnswers = {};
            
            try {
                const data = await apiCall('/micro/start', {
                    method: 'POST',
                    body: JSON.stringify({ user_id: currentUser, topic_id: '1.2' })
                });
                
                currentQuestions = data.questions;
                renderMicroQuestion();
                showPage('page-micro');
            } catch (e) {
                alert('è¼‰å…¥é¡Œç›®å¤±æ•—: ' + e.message);
            }
        }
        
        function renderMicroQuestion() {
            const q = currentQuestions[currentQuestionIndex];
            const total = currentQuestions.length;
            
            let html = `
                <div class="question-card">
                    <p class="question-num">é¡Œç›® ${currentQuestionIndex + 1} / ${total}</p>
                    <p class="question-stem">${q.stem}</p>
                </div>
            `;
            
            // é€‰é¡¹
            const options = ['A', 'B', 'C', 'D'];
            for (const opt of options) {
                if (!q.options[opt]) continue;
                const selected = currentAnswers[q.question_id] === opt ? 'selected' : '';
                html += `
                    <div class="option ${selected}" onclick="selectOption('${q.question_id}', '${opt}')">
                        <span class="option-label">${opt}.</span>
                        ${q.options[opt]}
                    </div>
                `;
            }
            
            // å¯¼èˆªæŒ‰é’®
            let navHtml = '';
            if (currentQuestionIndex > 0) {
                navHtml += `<button class="btn btn-outline" style="width:48%" onclick="prevMicroQuestion()">ä¸Šä¸€é¡Œ</button>`;
            }
            
            if (currentQuestionIndex < total - 1) {
                navHtml += `<button class="btn" style="width:48%;float:right" onclick="nextMicroQuestion()" id="btn-next">ä¸‹ä¸€é¡Œ</button>`;
            } else {
                navHtml += `<button class="btn btn-secondary" style="width:48%;float:right" onclick="submitMicro()" id="btn-submit">æäº¤</button>`;
            }
            
            html += `<div style="overflow:hidden;margin-top:16px">${navHtml}</div>`;
            
            document.getElementById('micro-content').innerHTML = html;
            updateMicroButtonState();
        }
        
        function selectOption(qid, opt) {
            currentAnswers[qid] = opt;
            renderMicroQuestion();
        }
        
        function updateMicroButtonState() {
            const q = currentQuestions[currentQuestionIndex];
            const btnId = currentQuestionIndex < currentQuestions.length - 1 ? 'btn-next' : 'btn-submit';
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.disabled = !currentAnswers[q.question_id];
            }
        }
        
        function prevMicroQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderMicroQuestion();
            }
        }
        
        function nextMicroQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                renderMicroQuestion();
            }
        }
        
        async function submitMicro() {
            // æ”¶é›† attempts
            const attempts = [];
            for (const q of currentQuestions) {
                const selected = currentAnswers[q.question_id];
                if (selected) {
                    attempts.push({
                        question_id: q.question_id,
                        selected_option: selected
                    });
                }
            }
            
            if (attempts.length === 0) {
                alert('è«‹è‡³å°‘å›ç­”ä¸€é¡Œ');
                return;
            }
            
            try {
                const data = await apiCall('/micro/submit', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser,
                        topic_id: '1.2',
                        attempts: attempts,
                        is_incomplete: attempts.length < currentQuestions.length
                    })
                });
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦è¿›å…¥ evaluation
                if (data.eval_ready) {
                    goToEvaluation();
                } else {
                    // å›åˆ° dashboard
                    alert(`Micro Session å®Œæˆï¼\næ­£ç¢ºç‡: ${(data.micro_summary.overall_acc * 100).toFixed(0)}%`);
                    refreshDashboard();
                }
            } catch (e) {
                alert('æäº¤å¤±æ•—: ' + e.message);
            }
        }
        
        // ============================================================
        // é¡µé¢: Evaluation
        // ============================================================
        async function goToEvaluation() {
            try {
                const data = await apiCall(`/evaluation?user_id=${currentUser}`);
                const evalResult = data.eval_result;
                
                let html = `
                    <div class="result-card">
                        <div class="result-percent">${(evalResult.overall_acc * 100).toFixed(0)}%</div>
                        <div class="result-label">æ•´é«”æ­£ç¢ºç‡ (${evalResult.total_correct} / ${evalResult.total_attempted})</div>
                    </div>
                `;
                
                // ç»´åº¦è¿›åº¦æ¡
                html += '<div class="dashboard-card">';
                for (const dim of ['COST_STRUCTURE', 'ALT_LOGIC', 'SUNK_FILTER']) {
                    const dimData = evalResult.all_dimensions[dim];
                    if (!dimData) continue;
                    
                    const acc = dimData.acc || 0;
                    const count = dimData.count || 0;
                    let statusClass = 'ok';
                    let statusText = 'âœ…';
                    
                    if (dimData.status === 'WEAK_DETECTED') {
                        statusClass = 'weak';
                        statusText = 'âš ï¸ å¼±é»';
                    } else if (dimData.status === 'NEEDS_ATTENTION') {
                        statusClass = 'attention';
                        statusText = 'âš ï¸ é—œæ³¨';
                    } else if (dimData.status === 'INSUFFICIENT') {
                        statusClass = 'insufficient';
                        statusText = 'â“ ä¸è¶³';
                    }
                    
                    html += `
                        <div class="dim-row">
                            <div class="dim-name">${dimToCn(dim)}</div>
                            <div class="dim-bar">
                                <div class="dim-fill ${statusClass}" style="width: ${acc * 100}%"></div>
                            </div>
                            <div class="dim-percent">${(acc * 100).toFixed(0)}%</div>
                        </div>
                    `;
                }
                html += '</div>';
                
                // å¼±ç‚¹æ¶ˆæ¯
                const wd = evalResult.weakness_detection;
                if (wd.status === 'WEAK_DETECTED') {
                    html += showMessage(wd.message || 'æª¢æ¸¬åˆ°å¼±é»', 'warning');
                } else if (wd.status === 'INSUFFICIENT_DATA') {
                    html += showMessage('æ•¸æ“šä¸è¶³ï¼Œç¹¼çºŒå®Œæˆæ›´å¤šç·´ç¿’åå†æŸ¥çœ‹è©•å®š', 'info');
                } else if (wd.status === 'ALL_OK') {
                    html += showMessage('æ•´é«”è¡¨ç¾è‰¯å¥½ï¼Œç¹¼çºŒä¿æŒï¼', 'success');
                }
                
                // æŒ‰é’®
                if (wd.status === 'WEAK_DETECTED') {
                    currentWeakDimension = wd.weak_dimension;
                    html += `<button class="btn" onclick="goToChallenge()">é–‹å§‹å°ˆé …æŒ‘æˆ°</button>`;
                }
                
                html += `<button class="btn btn-outline" onclick="refreshDashboard()">è¿”å›</button>`;
                
                document.getElementById('eval-content').innerHTML = html;
                showPage('page-evaluation');
            } catch (e) {
                alert('è©•å®šå¤±æ•—: ' + e.message);
                refreshDashboard();
            }
        }
        
        // ============================================================
        // é¡µé¢: Challenge
        // ============================================================
        async function goToChallenge() {
            currentQuestionIndex = 0;
            currentAnswers = {};
            
            try {
                const data = await apiCall('/challenge/start', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser,
                        topic_id: '1.2',
                        weak_dimension: currentWeakDimension,
                        pool_policy: 'strict'
                    })
                });
                
                currentQuestions = data.questions;
                document.getElementById('challenge-dim').textContent = `é‡å°: ${dimToCn(currentWeakDimension)}`;
                renderChallengeQuestion();
                showPage('page-challenge');
            } catch (e) {
                alert('è¼‰å…¥æŒ‘æˆ°é¡Œç›®å¤±æ•—: ' + e.message);
            }
        }
        
        function renderChallengeQuestion() {
            const q = currentQuestions[currentQuestionIndex];
            const total = currentQuestions.length;
            const state = currentQuestions[0]?.ability_dimension || ''; // placeholder
            
            let html = `
                <div class="question-card">
                    <p class="question-num">é¡Œç›® ${currentQuestionIndex + 1} / ${total}</p>
                    <p class="question-stem">${q.stem}</p>
                </div>
            `;
            
            const options = ['A', 'B', 'C', 'D'];
            for (const opt of options) {
                if (!q.options[opt]) continue;
                const selected = currentAnswers[q.question_id] === opt ? 'selected' : '';
                html += `
                    <div class="option ${selected}" onclick="selectChallengeOption('${q.question_id}', '${opt}')">
                        <span class="option-label">${opt}.</span>
                        ${q.options[opt]}
                    </div>
                `;
            }
            
            let navHtml = '';
            if (currentQuestionIndex > 0) {
                navHtml += `<button class="btn btn-outline" style="width:48%" onclick="prevChallengeQuestion()">ä¸Šä¸€é¡Œ</button>`;
            }
            
            if (currentQuestionIndex < total - 1) {
                navHtml += `<button class="btn" style="width:48%;float:right" onclick="nextChallengeQuestion()" id="btn-challenge-next">ä¸‹ä¸€é¡Œ</button>`;
            } else {
                navHtml += `<button class="btn btn-secondary" style="width:48%;float:right" onclick="submitChallenge()" id="btn-challenge-submit">æäº¤</button>`;
            }
            
            html += `<div style="overflow:hidden;margin-top:16px">${navHtml}</div>`;
            
            document.getElementById('challenge-content').innerHTML = html;
            updateChallengeButtonState();
        }
        
        function selectChallengeOption(qid, opt) {
            currentAnswers[qid] = opt;
            renderChallengeQuestion();
        }
        
        function updateChallengeButtonState() {
            const q = currentQuestions[currentQuestionIndex];
            const btnId = currentQuestionIndex < currentQuestions.length - 1 ? 'btn-challenge-next' : 'btn-challenge-submit';
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.disabled = !currentAnswers[q.question_id];
            }
        }
        
        function prevChallengeQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderChallengeQuestion();
            }
        }
        
        function nextChallengeQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                renderChallengeQuestion();
            }
        }
        
        async function submitChallenge() {
            const attempts = [];
            for (const q of currentQuestions) {
                const selected = currentAnswers[q.question_id];
                if (selected) {
                    attempts.push({
                        question_id: q.question_id,
                        selected_option: selected
                    });
                }
            }
            
            if (attempts.length === 0) {
                alert('è«‹è‡³å°‘å›ç­”ä¸€é¡Œ');
                return;
            }
            
            try {
                const data = await apiCall('/challenge/submit', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser,
                        topic_id: '1.2',
                        weak_dimension: currentWeakDimension,
                        attempts: attempts
                    })
                });
                
                // æ˜¾ç¤ºç»“æœ
                const acc = data.challenge_acc;
                const state = data.new_state;
                
                let html = `
                    <div class="result-card">
                        <div class="result-percent">${(acc * 100).toFixed(0)}%</div>
                        <div class="result-label">æŒ‘æˆ°æ­£ç¢ºç‡</div>
                    </div>
                `;
                
                if (state.status === 'STABLE') {
                    html += showMessage('ğŸ‰ æ­å–œï¼å¼±é»å·²è§£é™¤ï¼', 'success');
                } else {
                    html += showMessage(state.message || 'ç¹¼çºŒåŠ æ²¹', 'warning');
                }
                
                html += `<button class="btn" onclick="refreshDashboard()">è¿”å› Dashboard</button>`;
                
                document.getElementById('challenge-result-content').innerHTML = html;
                showPage('page-challenge-result');
            } catch (e) {
                alert('æäº¤å¤±æ•—: ' + e.message);
            }
        }
        
        // ============================================================
        // åˆå§‹åŒ–
        // ============================================================
        showPage('page-login');
    </script>
</body>
</html>
